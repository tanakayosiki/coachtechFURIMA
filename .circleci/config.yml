version: 2.1

orbs:
    aws-cli: circleci/aws-cli@3.1.3
    aws-ecs: circleci/aws-ecs@3.2.0

executors:
    deploy_container:
        docker:
          - image: cimg/python:3.10
        resource_class: small

commands:
    build-and-push:
        steps:
              - run:
                  name: Docker build
                  command: |
                    docker build --platform linux/amd64 -t ecr-image -f Dockerfile .
              - run:
                  name: Push to AWS ECR
                  command: |
                    aws ecr get-login-password --region ${AWS_DEFAULT_REGION} |  \
                    docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com
                    docker tag ecr-image:latest ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/ecr-image:latest
                    docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/ecr-image:latest

jobs:
    deploy-image:
        executor: deploy_container
        steps:
            - checkout
            - setup_remote_docker
            - aws-cli/install
            - aws-cli/setup
            - build-and-push

workflows:
    deploy:
        - deploy-image
        - aws-ecs/deploy-service-update:
            cluster: cluster
            family: ecs-task
            service-name: ecs-service